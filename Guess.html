<!doctype html>
<html>
	<head>
		<title>Guess My Number</title>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.0/css/materialize.min.css">
		<script src="https://cdn.socket.io/socket.io-1.3.6.js"></script>
			<script src="http://code.jquery.com/jquery-1.11.1.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.0/js/materialize.min.js"></script>
	</head>
	<style type="text/css">
	.message {
		width: 100%;
		height: 40px;
		position: relative;
	}
	.self {
		padding: 5px 10px 5px 10px;
		background-color: #69f0ae;
		border: #69f0ae 1px solid;
		border-radius: 5px;
	}
	.other {
		padding: 5px 10px 5px 10px;
		background-color: #f06292;
		border: #f06292 1px solid;
		border-radius: 5px;
		float: right;
	}
	</style>
	<body>
		<div class="container">
			<div class="row">
				<div class="col s12">
					<h3 class="center-align">Guess My Number</h3>
				</div>
			</div>
			<div class="row" id="newUserContainer">
				<div class="input-field col s6 offset-s3">
					<input type="text" id="n" class="validate" autocomplete="off" placeHolder="Your nickname" maxlength="10"/>
				</div>
				<div class="input-field col s6 offset-s3">
					<input type="text" id="r" class="validate" autocomplete="off" placeHolder="Room number" maxlength="10"/>
				</div>
				<div class="input-field col s6 offset-s3 center-align">
					<button id="enter" class="btn waves-effect waves-light">enter</button>
					<!--<a id="newRoom" href="javascript:;">Create New Room</a>-->
				</div>
			</div>
			<div class="row" id="battleField" style="display:none;">
				<div class="col s8 valign-wrapper" style="height:250px;" id="outter-container">
					<div style="width:100%;" class="valign center" id="inner-contaier">
						
					</div>
				</div>
				<div class="col s8" id="guesses-container" style="display:none;">
					<ul id="guesses" style="overflow-y: scroll;height: 200px; width:100%; max-height: 200px;"></ul>
					<input type="number" id="g" class="validate" autocomplete="off" onkeydown="if (event.keyCode == 13) sendGuess();" placeholder="New guess" maxlength="4"/>
					<button type="button" onclick="sendGuess()" class="btn waves-effect deep-orange accent-3">Guess</button>
				</div>
				<div class="col s4">
					<ul id="messages" style="overflow-y: scroll;height: 200px; width:100%; max-height: 200px;">
					</ul>
					<input type="text" id="m" class="validate" autocomplete="off" onkeydown="if (event.keyCode == 13) sendMessage();" placeholder="New message" maxlength="200"/>
					<button type="button" onclick="sendMessage()" class="btn waves-effect blue lighten-1">Send</button>
				</div>
			</div>
		</div>
	<ul id="guessField"></ul>
	<div class="wrapper" style="display:none">
	<input id="g" autocomplete="off" placeHolder="yr guess" maxlength="10"/><button id="guess" disabled>Guess</button>
	</div>
	</body>
	<script type="text/javascript">

		var socket = io();

		function sendMessage() {
			var message = $("#m").val().trim();
			if (message.length == 0) {
				Materialize.toast("Message cannot be empty", 2000);
				return;
			}
			socket.emit('chat message', message);
			$('#m').val('');
			$('#m').focus();
			return false;
		}

		function confirmReady() {
			var number_reg = /^(\d){4}$/i;
			var number = $("#number").val().trim();
			if (number.length == 0) {
				Materialize.toast("Number cannot be empty", 2000);
				return;
			} else if (!number_reg.test(number)) {
				Materialize.toast("The number must have 4 digits.", 2000);
				return;
			}
			socket.emit('user operation', {"operation": 50, "number": parseInt(number)});
			return false;
		}

		function startGame() {
			var number_reg = /^(\d){4}$/i;
			var number = $("#number").val().trim();
			if (number.length == 0) {
				Materialize.toast("Number cannot be empty", 2000);
				return;
			} else if (!number_reg.test(number)) {
				Materialize.toast("The number must have 4 digits.", 2000);
				return;
			}
			socket.emit('user operation', {"operation": 51, "number": parseInt(number)});
			return false;
		}

		$('#enter').click(function(){
			if ($.trim($("#r").val())===""){
				Materialize.toast("enter a room number", 2000);
				return false;
			}
			socket.emit('user nickname', {"nickname": $('#n').val(), "roomNum": $.trim($("#r").val())});
			document.title = $('#n').val();
			return false;
		});

		socket.on("error", function(msg) {
			switch (msg["statusCode"]) {
			case 0:
				Materialize.toast("You failed to join this room.", 2000);
				break;
			case 1:
				Materialize.toast("Room is full.", 2000);
				break;
			case 2:
				Materialize.toast("Duplicate nickname.", 2000);
				break;
			case 3:
				Materialize.toast("You have created a new room, and you are the owner.", 2000);
				break;
			case 4:
				Materialize.toast("You have already logged in.", 2000);
				break;
			case 5:
				Materialize.toast("No such room available.", 2000);
				break;
			case 6:
				Materialize.toast("You don't have permission to do so.", 2000);
				break;
			case 7: 
				Materialize.toast("You opponent is not ready.", 2000);
				break;
			default:
				console.log("Unkown error");
			}
		});

		var isOwner = false
		socket.on("success", function(msg) {
			switch (msg["statusCode"]) {
			case 101:
				var elements = msg["content"].split(":");
				$("#newUserContainer").hide();
				$("#battleField").show();
				if (elements[0] == elements[1]) {
					isOwner = true
					$(".valign").html('<input type="number" id="number" class="validate" autocomplete="off" onkeydown="if (event.keyCode == 13) start();" placeholder="New guess" maxlength="4"/><button type="button" id="start-button" class="btn-floating btn-large waves-effect waves-light red" onclick="startGame()" disabled>Start</button>');
				} else {
					if (!isOwner) {
						$(".valign").html('<input type="number" id="number" class="validate" autocomplete="off" onkeydown="if (event.keyCode == 13) confirmReady();" placeholder="New guess" maxlength="4"/><a href="javascript:;" id="ready-button" class="btn-floating btn-large waves-effect waves-light deep-purple lighten-2" onclick="confirmReady()">Ready</a>');
					}
				}
				$('#messages').append($('<li>').text(elements[1] +" entered your room~"));
				break;
			}
		})

		//receive chat message from server
		socket.on('chat message', function(msg){
			$('#messages').append(msg);
			var messages = document.getElementById("messages");
			messages.scrollTop = messages.scrollHeight;
		});

		socket.on('user operation', function(msg){
			switch (msg["statusCode"]) {
			case 100:
				if (isOwner) {
					$("#start-button").attr("disabled", false);
				} else {
					$("#inner-contaier").html("<h3>Please wait the host to start the game</h3>");
				}
				break;
			case 102:
				$("#outter-container").hide();
				$("#guesses-container").show();
				break;
			case 103:
				$("#start-button").attr("disabled", true);
				$("#outter-container").show();
				$("#guesses-container").hide();
				break;
			}
		});
	</script>
</html>